<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador ST - Reajuste Falso Coletivo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    label, input { display: block; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
    th { background-color: #f0f0f0; }
    .center { text-align: center; }
    #chartContainer { max-width: 800px; margin-top: 30px; }
    #logo { width: 200px; margin-bottom: 20px; }
  </style>
</head>
<body>

  <img src="logo.png" alt="Logo" id="logo" />
  <h1>Simulador Reajuste Plano de Saúde</h1>

  <label>Data de Inclusão:
    <input type="month" id="dataInicio" value="2020-11"/>
  </label>
  <label>Data do Último Pagamento:
    <input type="month" id="dataFim" value="2025-02"/>
  </label>
  <label>Valor da Última Mensalidade:
    <input type="number" id="valorFinal" value="4000"/>
  </label>

  <button onclick="simular()">Simular</button>
  <button onclick="exportarPDF()">Exportar PDF</button>

  <div id="resultado"></div>
  <div id="chartContainer"><canvas id="grafico"></canvas></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const indicesANS = {
      2024: 0.0691, 2023: 0.0963, 2022: 0.1550, 2021: -0.0819, 2020: 0.0814,
      2019: 0.0735, 2018: 0.10, 2017: 0.1355, 2016: 0.1357, 2015: 0.1355,
      2014: 0.0965, 2013: 0.0904, 2012: 0.0793, 2011: 0.0769, 2010: 0.0673,
      2009: 0.0676, 2008: 0.0548, 2007: 0.0576, 2006: 0.0889, 2005: 0.1169,
      2004: 0.1175, 2003: 0.0927, 2002: 0.0769, 2001: 0.0871, 2000: 0.0542
    };

    function simular() {
      const dataInicio = new Date(document.getElementById('dataInicio').value + '-01');
      const dataFim = new Date(document.getElementById('dataFim').value + '-01');
      const valorFinal = parseFloat(document.getElementById('valorFinal').value);
      const meses = [];
      let atual = new Date(dataFim);
      const reajusteReal = 0.18;

      while (atual >= dataInicio) {
        meses.unshift({
          ano: atual.getFullYear(),
          mes: atual.getMonth(),
          nome: atual.toLocaleDateString('pt-BR', { year: 'numeric', month: 'short' }),
          valorPago: 0,
          valorANS: 0
        });
        atual.setMonth(atual.getMonth() - 1);
      }

      // Reajuste real regressivo
      let valor = valorFinal;
      for (let i = meses.length - 1; i >= 0; i--) {
        meses[i].valorPago = valor;
        if (i > 0 && meses[i - 1].mes === 9) {
          valor = valor / (1 + reajusteReal); // outubro
        }
      }

      // Reajuste ANS progressivo
      let valorANS = meses[0].valorPago;
      for (let i = 0; i < meses.length; i++) {
        const { ano, mes } = meses[i];
        if (mes === 9 && i !== 0) {
          const perc = indicesANS[ano] ?? 0.07;
          valorANS *= (1 + perc);
        }
        meses[i].valorANS = valorANS;
      }

      let totalPago = 0;
      let totalANS = 0;
      let html = `
        <h2>Resultados da Simulação</h2>
        <p><strong>Você pagou a mais:</strong> R$ ${(meses.reduce((s, m) => s + (m.valorPago - m.valorANS), 0)).toFixed(2)}</p>
        <table><tr>
          <th>Mês</th><th>Valor Pago</th><th>Valor ANS</th><th>Diferença</th>
        </tr>`;

      meses.forEach(m => {
        totalPago += m.valorPago;
        totalANS += m.valorANS;
        html += `<tr>
          <td class="center">${m.nome}</td>
          <td>R$ ${m.valorPago.toFixed(2)}</td>
          <td>R$ ${m.valorANS.toFixed(2)}</td>
          <td>R$ ${(m.valorPago - m.valorANS).toFixed(2)}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('resultado').innerHTML = html;

      gerarGrafico(meses);
    }

    function gerarGrafico(meses) {
      const ctx = document.getElementById('grafico').getContext('2d');
      if (window.grafico) window.grafico.destroy();
      window.grafico = new Chart(ctx, {
        type: 'line',
        data: {
          labels: meses.map(m => m.nome),
          datasets: [
            { label: 'Pago', data: meses.map(m => m.valorPago), borderColor: 'red', fill: false },
            { label: 'ANS', data: meses.map(m => m.valorANS), borderColor: 'green', fill: false }
          ]
        },
        options: { responsive: true }
      });
    }

    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');

      pdf.addImage(document.getElementById('logo'), 'PNG', 40, 20, 150, 50);
      pdf.text("Simulação de Reajustes", 40, 100);

      const canvas = document.getElementById('grafico');
      const imgData = canvas.toDataURL('image/png');
      pdf.addImage(imgData, 'PNG', 40, 120, 500, 300);

      pdf.save('simulacao.pdf');
    }
  </script>
</body>
</html>
