<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Simulador ST - Reajustes de Plano de SaÃºde</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f2f2f2;
    }
    h1 {
      text-align: center;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      background: #0055a5;
      color: white;
      border: none;
      cursor: pointer;
    }
    #resultado, #graficoContainer {
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      border-radius: 8px;
      max-width: 700px;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="Logo da empresa" width="150">
  </div>

  <h1>Simulador de Reajuste Indevido</h1>
  
  <form id="simulador">
    <input type="text" id="nome" placeholder="Nome do Cliente" required>
    <input type="text" id="plano" placeholder="Nome do Plano" required>
    <input type="email" id="email" placeholder="E-mail" required>
    <input type="tel" id="whatsapp" placeholder="WhatsApp" required>
    
    <label>Data de InclusÃ£o no Plano:</label>
    <input type="month" id="dataInicio" required>

    <label>Data do Ãšltimo Pagamento:</label>
    <input type="month" id="dataFim" required>

    <label>Valor da Ãšltima Mensalidade:</label>
    <input type="number" id="valorAtual" placeholder="R$" required>

    <button type="submit">Simular</button>
  </form>

  <div id="resultado"></div>
  <div id="graficoContainer">
    <canvas id="grafico"></canvas>
    <button onclick="exportarPDF()">Exportar em PDF</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const token = 'cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0';
    const pipeline_id = 3;
    const stage_id = 8;
    const reajusteANS = 0.0875;
    const reajusteReal = 0.18;

    document.getElementById('simulador').addEventListener('submit', async function (e) {
      e.preventDefault();

      const nome = document.getElementById('nome').value;
      const plano = document.getElementById('plano').value;
      const email = document.getElementById('email').value;
      const whatsapp = document.getElementById('whatsapp').value;
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;
      const valorAtual = parseFloat(document.getElementById('valorAtual').value);

      const meses = calcularMeses(dataInicio, dataFim);
      let valorANS = valorAtual;
      let valorReal = valorAtual;

      let totalANS = 0;
      let totalReal = 0;

      const mesesLabels = [];
      const ansData = [];
      const realData = [];

      for (let i = 0; i < meses; i++) {
        mesesLabels.unshift(`M${meses - i}`);
        ansData.unshift(valorANS);
        realData.unshift(valorReal);

        totalANS += valorANS;
        totalReal += valorReal;

        valorANS /= (1 + reajusteANS / 12);
        valorReal /= (1 + reajusteReal / 12);
      }

      const diferenca = totalReal - totalANS;
      const estimativaFutura = valorAtual * 12 * reajusteReal;

      document.getElementById('resultado').innerHTML = `
        <h2>Resultado da SimulaÃ§Ã£o</h2>
        <p>VocÃª pagou <strong>R$ ${diferenca.toFixed(2)}</strong> a mais nos Ãºltimos ${meses} meses.</p>
        <p>Se continuar assim, pagarÃ¡ <strong>R$ ${estimativaFutura.toFixed(2)}</strong> a mais nos prÃ³ximos 12 meses.</p>
      `;

      gerarGrafico(mesesLabels, realData, ansData);

      const personRes = await fetch(`https://api.pipedrive.com/v1/persons?api_token=${token}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: nome, email: email, phone: whatsapp })
      });

      const personData = await personRes.json();
      const personId = personData.data.id;

      await fetch(`https://api.pipedrive.com/v1/deals?api_token=${token}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: `SimulaÃ§Ã£o - ${nome}`,
          person_id: personId,
          pipeline_id,
          stage_id,
          note: `
ðŸ“‹ Plano Simulado: ${plano}
ðŸ“… InÃ­cio no Plano: ${dataInicio}
ðŸ“† Ãšltimo Pagamento: ${dataFim}
ðŸ’° Valor da Ãšltima Mensalidade: R$ ${valorAtual}

ðŸ“Š Resultado:
VocÃª pagou R$ ${diferenca.toFixed(2)} a mais nos Ãºltimos ${meses} meses.
Se continuar assim, pagarÃ¡ R$ ${estimativaFutura.toFixed(2)} a mais nos prÃ³ximos 12 meses.
          `
        })
      });
    });

    function calcularMeses(inicio, fim) {
      const [a1, m1] = inicio.split('-').map(Number);
      const [a2, m2] = fim.split('-').map(Number);
      return (a2 - a1) * 12 + (m2 - m1) + 1;
    }

    function gerarGrafico(labels, dadosReais, dadosANS) {
      const ctx = document.getElementById('grafico').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Valor Pago',
              data: dadosReais,
              borderColor: 'red',
              fill: false
            },
            {
              label: 'Valor devido ANS',
              data: dadosANS,
              borderColor: 'green',
              fill: false
            }
          ]
        }
      });
    }

    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Resultado da SimulaÃ§Ã£o", 10, 10);
      doc.text(document.getElementById('resultado').innerText, 10, 20);

      const canvas = document.querySelector('#grafico');
      const imgData = canvas.toDataURL('image/png');
      doc.addImage(imgData, 'PNG', 10, 50, 180, 100);
      doc.save("simulacao.pdf");
    }
  </script>
</body>
</html>
