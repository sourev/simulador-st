<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador ST</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }

    .logo {
      text-align: center;
      margin-bottom: 20px;
    }

    .logo img {
      max-width: 200px;
    }

    h1 {
      text-align: center;
      color: #222;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
    }

    button {
      background: #0066cc;
      color: white;
      padding: 12px 20px;
      margin-top: 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    #resultado {
      margin-top: 30px;
      background: #eef;
      padding: 20px;
      border-radius: 8px;
      display: none;
    }

    canvas {
      margin-top: 20px;
      max-width: 100%;
    }

    #exportarPdf {
      margin-top: 20px;
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="logo.png" alt="Logo" />
    </div>

    <h1>Simulador de Reembolso - ST</h1>

    <form id="simuladorForm">
      <label>Nome do Cliente:</label>
      <input type="text" id="nomeCliente" required>

      <label>Nome do Plano:</label>
      <input type="text" id="nomePlano" required>

      <label>WhatsApp:</label>
      <input type="text" id="whatsapp" required>

      <label>E-mail:</label>
      <input type="email" id="email" required>

      <label>Data de Inclus√£o no Plano:</label>
      <input type="month" id="dataInclusao" required>

      <label>Data do √öltimo Pagamento:</label>
      <input type="month" id="dataUltimoPagamento" required>

      <label>Valor da √öltima Mensalidade (R$):</label>
      <input type="number" id="valorMensalidade" required>

      <button type="submit">Simular</button>
      <button type="button" id="exportarPdf">üìÑ Exportar PDF</button>
    </form>

    <div id="resultado">
      <h2>Resultado da Simula√ß√£o</h2>
      <p id="resumo"></p>
      <canvas id="grafico"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const reajustesANS = {
      "2024": 6.91,
      "2023": 9.63,
      "2022": 15.5,
      "2021": -8.19,
      "2020": 8.14,
      "2019": 7.35,
      "2018": 10.0,
      "2017": 13.55,
      "2016": 13.57,
      "2015": 13.55,
      "2014": 9.65,
      "2013": 9.04,
      "2012": 7.93,
      "2011": 7.69,
      "2010": 6.73,
      "2009": 6.76,
      "2008": 5.48,
      "2007": 5.76,
      "2006": 8.89,
      "2005": 11.69,
      "2004": 11.75,
      "2003": 9.27,
      "2002": 7.69,
      "2001": 8.71,
      "2000": 5.42
    };

    const REAJUSTE_REAL = 22; // fixo

    document.getElementById("simuladorForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const nome = document.getElementById("nomeCliente").value;
      const plano = document.getElementById("nomePlano").value;
      const whatsapp = document.getElementById("whatsapp").value;
      const email = document.getElementById("email").value;
      const dataInicio = new Date(document.getElementById("dataInclusao").value);
      const dataFim = new Date(document.getElementById("dataUltimoPagamento").value);
      const valorAtual = parseFloat(document.getElementById("valorMensalidade").value);

      const meses = [];
      const pagos = [];
      const devidos = [];

      let mesesPagos = 0;
      let totalPago = 0;
      let totalDevido = 0;

      let valorReal = valorAtual;
      let valorANS = valorAtual;

      for (
        let dt = new Date(dataFim);
        dt >= dataInicio;
        dt.setMonth(dt.getMonth() - 1)
      ) {
        const ano = dt.getFullYear();
        const mes = dt.getMonth() + 1;
        const rotulo = `${mes.toString().padStart(2, '0')}/${ano}`;
        meses.unshift(rotulo);

        // Regress√£o do valor pago (reajuste real 22% ao ano)
        valorReal = valorReal / (1 + REAJUSTE_REAL / 100 / 12);
        pagos.unshift(valorReal);
        totalPago += valorReal;

        // Regress√£o do valor ANS
        const reajuste = reajustesANS[ano] ?? 7;
        valorANS = valorANS / (1 + reajuste / 100 / 12);
        devidos.unshift(valorANS);
        totalDevido += valorANS;

        mesesPagos++;
      }

      const diferenca = totalPago - totalDevido;
      const projecaoMensal = (valorReal - valorANS) * 12;

      document.getElementById("resultado").style.display = "block";
      document.getElementById("resumo").innerHTML = `
        Voc√™ pagou <strong>R$ ${diferenca.toFixed(2)}</strong> a mais nos √∫ltimos <strong>${mesesPagos}</strong> meses.<br>
        Se continuar assim, pagar√° <strong>R$ ${projecaoMensal.toFixed(2)}</strong> a mais nos pr√≥ximos 12 meses.
      `;

      const ctx = document.getElementById("grafico").getContext("2d");
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: meses,
          datasets: [
            {
              label: "Valor Pago",
              data: pagos,
              borderColor: "#f00",
              fill: false
            },
            {
              label: "Valor Devido (ANS)",
              data: devidos,
              borderColor: "#00f",
              fill: false
            }
          ]
        }
      });

      // Enviar para o Pipedrive
      const nota = `Simula√ß√£o ST\nCliente: ${nome}\nPlano: ${plano}\nWhatsApp: ${whatsapp}\nValor Atual: R$${valorAtual}\nData Entrada: ${dataInicio.toLocaleDateString()}\nData √öltima: ${dataFim.toLocaleDateString()}\nValor Pago: R$${totalPago.toFixed(2)}\nValor Devido ANS: R$${totalDevido.toFixed(2)}\nDiferen√ßa: R$${diferenca.toFixed(2)}`;
      await fetch("https://api.pipedrive.com/v1/deals?api_token=cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: `${nome} - Simula√ß√£o ST`,
          person_id: null,
          pipeline_id: 3,
          stage_id: 8,
          add_time: new Date().toISOString()
        })
      }).then(res => res.json()).then(async data => {
        if (data?.data?.id) {
          await fetch(`https://api.pipedrive.com/v1/notes?api_token=cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              content: nota,
              deal_id: data.data.id
            })
          });
        }
      });
    });

    document.getElementById("exportarPdf").addEventListener("click", () => {
      import("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js").then(jsPDF => {
        const { jsPDF: PDF } = jsPDF;
        const pdf = new PDF();
        pdf.text("Simula√ß√£o de Reembolso - ST", 10, 10);
        pdf.html(document.getElementById("resultado"), {
          callback: function (doc) {
            doc.save("simulacao-st.pdf");
          },
          x: 10,
          y: 20
        });
      });
    });
  </script>
</body>
</html>
