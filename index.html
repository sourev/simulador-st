<!-- Versão final - Simulador ST -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador de Restituição</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1, h2 {
      text-align: center;
    }
    img.logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
      background-color: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    #resultado {
      margin-top: 30px;
      padding: 15px;
      background-color: #e1f5fe;
      border-left: 5px solid #0288d1;
    }
    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

  <img src="logo.png" class="logo" alt="Logo" />

  <h1>Simulador de Restituição de Plano de Saúde</h1>

  <label for="nome">Nome completo*</label>
  <input id="nome" required />

  <label for="plano">Nome do Plano*</label>
  <input id="plano" required />

  <label for="whatsapp">WhatsApp*</label>
  <input id="whatsapp" required />

  <label for="email">E-mail*</label>
  <input id="email" type="email" required />

  <label for="entrada">Data de entrada no plano*</label>
  <input id="entrada" type="month" required />

  <label for="ultimo">Data do último pagamento*</label>
  <input id="ultimo" type="month" required />

  <label for="valor">Valor da última mensalidade (R$)*</label>
  <input id="valor" type="number" step="0.01" required />

  <button onclick="simular()">Simular</button>

  <div id="resultado" class="hidden"></div>
  <canvas id="grafico" class="hidden"></canvas>

  <button id="exportarBtn" class="hidden" onclick="exportarPDF()">Exportar PDF</button>

  <script>
    const ANS = {
      2024: 0.0691,
      2023: 0.0963,
      2022: 0.1550,
      2021: -0.0819,
      2020: 0.0814,
      2019: 0.0735,
      2018: 0.10,
      2017: 0.1355,
      2016: 0.1357,
      2015: 0.1355,
      2014: 0.0965,
      2013: 0.0904,
      2012: 0.0793,
      2011: 0.0769,
      2010: 0.0673,
      2009: 0.0676,
      2008: 0.0548,
      2007: 0.0576,
      2006: 0.0889,
      2005: 0.1169,
      2004: 0.1175,
      2003: 0.0927,
      2002: 0.0769,
      2001: 0.0871,
      2000: 0.0542
    };

    function aplicarReajuste(valor, percentual) {
      return valor / (1 + percentual);
    }

    function simular() {
      const nome = document.getElementById('nome').value.trim();
      const plano = document.getElementById('plano').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();
      const email = document.getElementById('email').value.trim();
      const entrada = document.getElementById('entrada').value;
      const ultimo = document.getElementById('ultimo').value;
      const valorAtual = parseFloat(document.getElementById('valor').value);

      if (!nome || !plano || !whatsapp || !email || !entrada || !ultimo || isNaN(valorAtual)) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      const inicio = new Date(entrada + "-01");
      const fim = new Date(ultimo + "-01");
      let atual = new Date(fim);
      let valor = valorAtual;
      const pago = [];
      const devido = [];
      const labels = [];

      let valorBaseANS = valor;
      while (atual >= inicio) {
        const mes = atual.toLocaleDateString('pt-BR', { year: 'numeric', month: 'short' });
        labels.unshift(mes);

        // VALOR PAGO
        pago.unshift(valor);

        // VALOR DEVIDO (ANS)
        devido.unshift(valorBaseANS);

        // Reajuste Real - Outubro
        if (atual.getMonth() === 9) {
          valor = aplicarReajuste(valor, 0.22);
        }

        // Reajuste ANS - Outubro
        if (atual.getMonth() === 9) {
          const ano = atual.getFullYear();
          const indice = ANS[ano] ?? 0.07;
          valorBaseANS = aplicarReajuste(valorBaseANS, indice);
        }

        atual.setMonth(atual.getMonth() - 1);
      }

      const totalPago = pago.reduce((a, b) => a + b, 0);
      const totalDevido = devido.reduce((a, b) => a + b, 0);
      const diferenca = totalPago - totalDevido;

      const msg = `
        <h2>Resultado da Simulação</h2>
        Você pagou <strong>R$ ${diferenca.toFixed(2)}</strong> a mais nos últimos <strong>${pago.length}</strong> meses.
        <br/>Se continuar assim, pagará <strong>R$ ${(diferenca / pago.length * 12).toFixed(2)}</strong> a mais nos próximos 12 meses.
      `;

      document.getElementById('resultado').classList.remove('hidden');
      document.getElementById('grafico').classList.remove('hidden');
      document.getElementById('exportarBtn').classList.remove('hidden');
      document.getElementById('resultado').innerHTML = msg;

      gerarGrafico(labels, pago, devido);

      // Enviar para Pipedrive
      fetch("https://api.pipedrive.com/v1/deals?api_token=cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: `${nome} - Simulação ST`,
          person_id: null,
          value: diferenca.toFixed(2),
          pipeline_id: 3,
          stage_id: 8
        })
      }).then(() => {
        // Adiciona nota com dados da simulação
        fetch("https://api.pipedrive.com/v1/notes?api_token=cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: `
              Plano: ${plano}\nWhatsApp: ${whatsapp}\nEmail: ${email}
              Entrada: ${entrada}\nÚltimo: ${ultimo}\nMensalidade: R$ ${valorAtual}
              Simulação: Diferença R$ ${diferenca.toFixed(2)} em ${pago.length} meses
            `,
            deal_id: null
          })
        });
      });
    }

    function gerarGrafico(labels, pago, devido) {
      const ctx = document.getElementById('grafico').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: "Valor Pago (Plano)",
              borderColor: "#e53935",
              data: pago,
              fill: false
            },
            {
              label: "Valor que Deveria ser Pago (ANS)",
              borderColor: "#43a047",
              data: devido,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Resultado da Simulação", 10, 10);
      doc.html(document.body, {
        callback: function (doc) {
          doc.save("simulacao.pdf");
        },
        x: 10,
        y: 20
      });
    }
  </script>
</body>
</html>
