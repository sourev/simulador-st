<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulador ST</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f7f7f7;
    }
    h1, h2 {
      text-align: center;
    }
    .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo img {
      width: 150px;
    }
    form {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    canvas {
      max-width: 700px;
      margin: 40px auto;
      display: block;
    }
    #resultado {
      background-color: #e3f2fd;
      padding: 20px;
      margin: 30px auto;
      max-width: 700px;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="logo">
  <img src="logo.png" alt="Logo">
</div>

<h1>Simulador ST</h1>

<form id="simuladorForm">
  <label>Nome do Cliente* <input required name="nome" /></label>
  <label>Nome do Plano* <input required name="plano" /></label>
  <label>WhatsApp* <input required name="whatsapp" /></label>
  <label>Email* <input type="email" required name="email" /></label>
  <label>Data de Inclusão no Plano* <input required type="month" name="inicio" /></label>
  <label>Data do Último Pagamento* <input required type="month" name="fim" /></label>
  <label>Valor da Última Mensalidade* <input required type="number" name="valor" step="0.01" /></label>
  <button type="submit">Simular</button>
</form>

<div id="resultado"></div>
<canvas id="grafico"></canvas>
<div style="text-align:center;">
  <button onclick="exportarPDF()">Exportar PDF</button>
</div>

<script>
const ansIndices = {
  2024: 6.91,
  2023: 9.63,
  2022: 15.50,
  2021: -8.19,
  2020: 8.14,
  2019: 7.35,
  2018: 10.00,
  2017: 13.55,
  2016: 13.57,
  2015: 13.55,
  2014: 9.65,
  2013: 9.04,
  2012: 7.93,
  2011: 7.69,
  2010: 6.73,
  2009: 6.76,
  2008: 5.48,
  2007: 5.76,
  2006: 8.89,
  2005: 11.69,
  2004: 11.75,
  2003: 9.27,
  2002: 7.69,
  2001: 8.71,
  2000: 5.42,
};

const REAJUSTE_REAL = 22;

document.getElementById('simuladorForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const form = new FormData(e.target);
  const inicio = new Date(form.get('inicio') + '-01');
  const fim = new Date(form.get('fim') + '-01');
  const valorFinal = parseFloat(form.get('valor'));

  const nome = form.get('nome');
  const plano = form.get('plano');
  const whatsapp = form.get('whatsapp');
  const email = form.get('email');

  const meses = [];
  const pagos = [];
  const ans = [];

  let atualPago = valorFinal;
  let atualAns = atualPago;

  let anoAtual = fim.getFullYear();
  let mesAtual = fim.getMonth();

  // Recalculando o valor ANS baseado no valor da entrada
  let valorInicial = valorFinal;

  for (let d = new Date(inicio); d <= fim; d.setMonth(d.getMonth() + 1)) {
    const label = d.toLocaleString('default', { month: 'short', year: 'numeric' });

    // Reajuste real sempre em outubro
    if (d.getMonth() === 9 && d < fim) {
      atualPago /= (1 + (REAJUSTE_REAL / 100));
    }

    // Reajuste ANS sempre em outubro
    if (d.getMonth() === 9 && d.getFullYear() in ansIndices) {
      atualAns /= (1 + (ansIndices[d.getFullYear()] / 100));
    }

    meses.push(label);
    pagos.push(atualPago.toFixed(2));
    ans.push(atualAns.toFixed(2));
  }

  const totalPago = pagos.reduce((a, b) => a + parseFloat(b), 0);
  const totalAns = ans.reduce((a, b) => a + parseFloat(b), 0);
  const diferenca = totalPago - totalAns;

  const projecao12Meses = diferenca / pagos.length * 12;

  document.getElementById('resultado').innerText =
    `Resultado da Simulação
Você pagou R$ ${diferenca.toFixed(2)} a mais nos últimos ${pagos.length} meses.
Se continuar assim, pagará R$ ${projecao12Meses.toFixed(2)} a mais nos próximos 12 meses.`;

  // Gráfico
  const ctx = document.getElementById('grafico').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Valor Pago',
          data: pagos,
          borderColor: 'red',
          fill: false,
        },
        {
          label: 'Valor que deveria ser pago (ANS)',
          data: ans,
          borderColor: 'green',
          fill: false,
        },
      ],
    },
  });

  // Enviar para Pipedrive
  enviarParaPipedrive({ nome, plano, whatsapp, email, inicio, fim, valorFinal, diferenca });
});

function enviarParaPipedrive(data) {
  const token = 'cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0'; // seu token
  const url = `https://api.pipedrive.com/v1/deals?api_token=${token}`;
  const nota = `Simulação concluída.

Data de entrada: ${data.inicio.toLocaleDateString()}
Último pagamento: ${data.fim.toLocaleDateString()}
Valor final: R$ ${data.valorFinal.toFixed(2)}
Diferença identificada: R$ ${data.diferenca.toFixed(2)}.`;

  fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      title: `Simulação - ${data.nome}`,
      person_id: null,
      pipeline_id: 3,
      stage_id: 8,
      value: data.valorFinal,
      status: 'open'
    })
  })
  .then(res => res.json())
  .then(res => {
    if (res.success) {
      const dealId = res.data.id;
      fetch(`https://api.pipedrive.com/v1/notes?api_token=${token}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          content: nota,
          deal_id: dealId
        })
      });
    }
  });
}

function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(document.getElementById('resultado').innerText, 10, 10);
  doc.save('simulacao.pdf');
}
</script>

</body>
</html>
