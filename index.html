<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador ST</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input, select {
      padding: 5px;
      width: 100%;
    }
    .resultado {
      margin-top: 30px;
      background: #f0f0f0;
      padding: 20px;
      border-radius: 8px;
    }
    .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo img {
      width: 200px;
    }
    #grafico {
      max-width: 800px;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="Logo"/>
  </div>

  <h2>Simulador de Reajuste de Plano de SaÃºde</h2>

  <label>Nome do Cliente</label>
  <input type="text" id="nome" />

  <label>Nome do Plano</label>
  <input type="text" id="plano" />

  <label>WhatsApp</label>
  <input type="text" id="whatsapp" />

  <label>Email</label>
  <input type="email" id="email" />

  <label>Data de InclusÃ£o no Plano</label>
  <input type="month" id="dataInicio" />

  <label>Data do Ãšltimo Pagamento</label>
  <input type="month" id="dataFim" />

  <label>Valor da Ãšltima Mensalidade</label>
  <input type="number" id="valorFinal" />

  <br/><br/>
  <button onclick="simular()">Simular</button>
  <button onclick="exportarPDF()">Exportar PDF</button>

  <div class="resultado" id="resultado"></div>

  <canvas id="grafico"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const reajustesANS = {
      "2024": 0.0691,
      "2023": 0.0963,
      "2022": 0.1550,
      "2021": -0.0819,
      "2020": 0.0814,
      "2019": 0.0735,
      "2018": 0.10,
      "2017": 0.1355,
      "2016": 0.1357,
      "2015": 0.1355,
      "2014": 0.0965,
      "2013": 0.0904,
      "2012": 0.0793,
      "2011": 0.0769,
      "2010": 0.0673,
      "2009": 0.0676,
      "2008": 0.0548,
      "2007": 0.0576,
      "2006": 0.0889,
      "2005": 0.1169,
      "2004": 0.1175,
      "2003": 0.0927,
      "2002": 0.0769,
      "2001": 0.0871,
      "2000": 0.0542,
    };

    async function simular() {
      const nome = document.getElementById("nome").value;
      const plano = document.getElementById("plano").value;
      const whatsapp = document.getElementById("whatsapp").value;
      const email = document.getElementById("email").value;
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;
      const valorFinal = parseFloat(document.getElementById("valorFinal").value);

      const inicio = new Date(dataInicio + "-01");
      const fim = new Date(dataFim + "-01");
      let atual = new Date(fim);
      let valorPago = 0;
      let valorDevido = 0;
      let meses = 0;
      let valorAtual = valorFinal;
      let valorAns = valorFinal;

      const dadosGrafico = {
        labels: [],
        pagos: [],
        ans: []
      };

      while (atual >= inicio) {
        const ano = atual.getFullYear();
        const mes = atual.getMonth();

        // Grava os valores no grÃ¡fico
        dadosGrafico.labels.unshift(atual.toLocaleDateString("pt-BR", { month: 'short', year: 'numeric' }));
        dadosGrafico.pagos.unshift(valorAtual);
        dadosGrafico.ans.unshift(valorAns);

        valorPago += valorAtual;
        valorDevido += valorAns;

        // Em outubro, aplica os reajustes
        if (mes === 9) {
          valorAtual /= 1.22; // 22% real
          valorAns /= (1 + (reajustesANS[ano] ?? 0.07)); // ANS ou mÃ©dia 7%
        }

        atual.setMonth(atual.getMonth() - 1);
        meses++;
      }

      const diferencaPassado = valorPago - valorDevido;
      const estimativaFutura = (valorAtual - valorAns) * 12;

      document.getElementById("resultado").innerHTML = `
        <h3>Resultado da SimulaÃ§Ã£o</h3>
        <p>VocÃª pagou <b>R$ ${diferencaPassado.toFixed(2)}</b> a mais nos Ãºltimos ${meses} meses.</p>
        <p>Se continuar assim, pagarÃ¡ <b>R$ ${estimativaFutura.toFixed(2)}</b> a mais nos prÃ³ximos 12 meses.</p>
      `;

      const ctx = document.getElementById('grafico').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dadosGrafico.labels,
          datasets: [
            {
              label: 'Valor Pago',
              data: dadosGrafico.pagos,
              borderColor: 'red',
              fill: false
            },
            {
              label: 'Valor que deveria ser pago (ANS)',
              data: dadosGrafico.ans,
              borderColor: 'green',
              fill: false
            }
          ]
        }
      });

      enviarPipeDrive(nome, email, whatsapp, plano, diferencaPassado, estimativaFutura, meses);
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Resultado da SimulaÃ§Ã£o", 10, 10);
      doc.html(document.querySelector(".resultado"), {
        callback: function (doc) {
          doc.save("simulacao.pdf");
        }
      });
    }

    function enviarPipeDrive(nome, email, whatsapp, plano, valorA, valorB, meses) {
      const dealData = {
        title: `${nome} - SimulaÃ§Ã£o Plano`,
        person_name: nome,
        value: valorA.toFixed(2),
        stage_id: 30,
        pipeline_id: 2
      };

      fetch("https://api.pipedrive.com/v1/deals?api_token=cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dealData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const dealId = data.data.id;

          const nota = `
ðŸ“Š SimulaÃ§Ã£o realizada:
â€¢ Cliente: ${nome}
â€¢ Plano: ${plano}
â€¢ WhatsApp: ${whatsapp}
â€¢ E-mail: ${email}
â€¢ Data de InclusÃ£o: ${document.getElementById("dataInicio").value}
â€¢ Ãšltimo Pagamento: ${document.getElementById("dataFim").value}
â€¢ Mensalidade Atual: R$ ${document.getElementById("valorFinal").value}

ðŸ’° Pagou R$ ${valorA.toFixed(2)} a mais nos Ãºltimos ${meses} meses.
ðŸ“ˆ Estimativa futura: R$ ${valorB.toFixed(2)}.
          `;

          fetch(`https://api.pipedrive.com/v1/notes?api_token=cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              content: nota,
              deal_id: dealId
            })
          });
        }
      });
    }
  </script>
</body>
</html>

