<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador ST</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    input, button, select {
      padding: 8px;
      margin: 5px;
      width: 250px;
    }
    .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo img {
      max-width: 200px;
    }
    canvas {
      margin-top: 30px;
      max-width: 800px;
      width: 100%;
    }
    #resultado {
      font-weight: bold;
      margin: 20px 0;
    }
  </style>
</head>
<body>

  <div class="logo">
    <img src="logo.png" alt="Logo"/>
  </div>

  <h2>Simulador de Reembolso Plano de Sa√∫de</h2>

  <form id="simuladorForm">
    <input type="text" id="nome" placeholder="Nome completo" required><br>
    <input type="text" id="whatsapp" placeholder="WhatsApp" required><br>
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="text" id="nomePlano" placeholder="Nome do plano de sa√∫de" required><br>

    <label>Data de Inclus√£o:</label><br>
    <input type="month" id="inicioPlano" required><br>

    <label>√öltimo Pagamento:</label><br>
    <input type="month" id="fimPlano" required><br>

    <label>Valor da √öltima Mensalidade (R$):</label><br>
    <input type="number" id="valorAtual" step="0.01" required><br>

    <button type="button" onclick="simular()">Simular</button>
    <button type="button" onclick="exportarPDF()">üìÑ Exportar PDF</button>
    <button type="button" onclick="compartilharWhatsApp()">üì≤ Enviar por WhatsApp</button>
  </form>

  <div id="resultado"></div>

  <canvas id="graficoComparativo"></canvas>

  <script>
    const indicesANS = {
      2024: 6.91,
      2023: 9.63,
      2022: 15.5,
      2021: -8.19,
      2020: 8.14,
      2019: 7.35,
      2018: 10.0,
      2017: 13.55,
      2016: 13.57,
      2015: 13.55,
      2014: 9.65,
      2013: 9.04,
      2012: 7.93,
      2011: 7.69,
      2010: 6.73
    };

    function simular() {
      const inicio = new Date(document.getElementById("inicioPlano").value + "-01");
      const fim = new Date(document.getElementById("fimPlano").value + "-01");
      const valorAtual = parseFloat(document.getElementById("valorAtual").value);
      const meses = [];
      const valorPago = [];
      const valorDevido = [];

      const reajusteReal = 22 / 12 / 100; // 22% ao ano, dividido por 12

      let valorMes = valorAtual;
      const inicioAno = inicio.getFullYear();
      const fimAno = fim.getFullYear();
      let dataTemp = new Date(fim);

      while (dataTemp >= inicio) {
        const ano = dataTemp.getFullYear();
        const mes = dataTemp.getMonth() + 1;
        const label = dataTemp.toLocaleDateString("pt-BR", { month: "short", year: "numeric" });

        meses.unshift(label);
        valorPago.unshift(valorMes.toFixed(2));

        // Calcular valor devido conforme ANS
        let valorANS = valorAtual;
        for (let y = fimAno; y > ano; y--) {
          valorANS /= (1 + (indicesANS[y] || 7) / 100);
        }

        valorDevido.unshift(valorANS.toFixed(2));
        valorMes = valorMes / (1 + reajusteReal);
        dataTemp.setMonth(dataTemp.getMonth() - 1);
      }

      const totalPago = valorPago.reduce((a, b) => a + parseFloat(b), 0);
      const totalDevido = valorDevido.reduce((a, b) => a + parseFloat(b), 0);
      const diferenca = (totalPago - totalDevido).toFixed(2);

      const economiaFutura = (valorAtual * 12) - (valorDevido[valorDevido.length - 1] * 12);

      document.getElementById("resultado").innerHTML = `
        <h3>Resultado da Simula√ß√£o</h3>
        Voc√™ pagou <b>R$ ${diferenca}</b> a mais nos √∫ltimos <b>${meses.length}</b> meses.<br>
        Se continuar assim, pagar√° <b>R$ ${economiaFutura.toFixed(2)}</b> a mais nos pr√≥ximos 12 meses.
      `;

      gerarGrafico(meses, valorPago, valorDevido);

      enviarParaPipedrive({
        nome: document.getElementById("nome").value,
        whatsapp: document.getElementById("whatsapp").value,
        email: document.getElementById("email").value,
        plano: document.getElementById("nomePlano").value,
        resultado: document.getElementById("resultado").innerText
      });
    }

    function gerarGrafico(labels, valoresPago, valoresDevido) {
      const ctx = document.getElementById('graficoComparativo').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Valor Pago',
              data: valoresPago,
              borderColor: 'red',
              fill: false
            },
            {
              label: 'Valor que deveria ser pago (ANS)',
              data: valoresDevido,
              borderColor: 'green',
              fill: false
            }
          ]
        }
      });
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Resultado da Simula√ß√£o", 10, 10);
      doc.text(document.getElementById("resultado").innerText, 10, 20);
      doc.save("simulacao.pdf");
    }

    function compartilharWhatsApp() {
      const nome = document.getElementById("nome").value;
      const mensagem = encodeURIComponent(`Ol√° ${nome}, segue o resultado da sua simula√ß√£o:\n\n${document.getElementById("resultado").innerText}`);
      window.open(`https://wa.me/?text=${mensagem}`, "_blank");
    }

    function enviarParaPipedrive(dados) {
      const token = "cd9eb8d752c61cc00505aa73e12bbc1f7289b9c0";
      fetch(`https://api.pipedrive.com/v1/leads?api_token=${token}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: `Simula√ß√£o - ${dados.nome}`,
          person_id: null,
          note: `Plano: ${dados.plano}\nWhatsApp: ${dados.whatsapp}\nEmail: ${dados.email}\n${dados.resultado}`,
          pipeline_id: 3,
          stage_id: 8
        })
      });
    }
  </script>
</body>
</html>
