<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador Reajustes ANS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 900px; margin: auto; }
    label, input { display: block; margin-top: 10px; }
    canvas { margin-top: 30px; }
    #logo { width: 150px; margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .destaque { font-weight: bold; background: #f0f0f0; }
    button { margin-top: 20px; padding: 8px 16px; }
  </style>
</head>
<body>

  <img src="logo.png" id="logo" alt="Logo">
  <h2>Simulador de Reajuste de Planos de SaÃºde</h2>

  <label>ðŸ“… Data de InclusÃ£o:
    <input type="month" id="dataInicio" value="2020-11">
  </label>

  <label>ðŸ“… Ãšltimo Pagamento:
    <input type="month" id="dataFim" value="2025-02">
  </label>

  <label>ðŸ’° Valor da Ãšltima Mensalidade:
    <input type="number" id="valorMensalidade" value="4000">
  </label>

  <button onclick="simular()">Simular</button>
  <button onclick="exportarPDF()">ðŸ“„ Exportar PDF</button>

  <div id="resultado"></div>
  <canvas id="grafico" height="100"></canvas>

  <script>
    const REAJUSTE_REAL_ANUAL = 0.18;
    const MESES_POR_ANO = 12;
    const indicesANS = {
      2015: 0.1355,
      2016: 0.1357,
      2017: 0.1355,
      2018: 0.10,
      2019: 0.0735,
      2020: 0.0814,
      2021: -0.0819,
      2022: 0.1550,
      2023: 0.0963,
      2024: 0.0691
    };
    const mediaIndiceANS = 0.07;

    function simular() {
      const dataInicio = new Date(document.getElementById("dataInicio").value + "-01");
      const dataFim = new Date(document.getElementById("dataFim").value + "-01");
      const valorFinal = parseFloat(document.getElementById("valorMensalidade").value);

      const meses = [];
      const valoresReais = [];
      const valoresANS = [];

      let totalMeses = (dataFim.getFullYear() - dataInicio.getFullYear()) * 12 + (dataFim.getMonth() - dataInicio.getMonth());
      let valorMensalAtualReal = valorFinal;
      for (let i = 0; i < totalMeses; i++) {
        valorMensalAtualReal /= (1 + REAJUSTE_REAL_ANUAL / MESES_POR_ANO);
      }
      const valorInicialPago = valorMensalAtualReal;

      let valorMensalAtualANS = valorInicialPago;

      for (let i = 0; i <= totalMeses; i++) {
        const data = new Date(dataInicio);
        data.setMonth(data.getMonth() + i);
        const ano = data.getFullYear();
        const mes = data.getMonth();

        const mesAno = data.toLocaleString('pt-BR', { month: 'short', year: 'numeric' });
        meses.push(mesAno);

        // Valor pago real com reajuste progressivo
        const valorReal = valorInicialPago * Math.pow(1 + REAJUSTE_REAL_ANUAL / MESES_POR_ANO, i);
        valoresReais.push(valorReal.toFixed(2));

        // Reajuste ANS apenas em outubro
        if (mes === 9 && i !== 0) {
          const indice = indicesANS[ano] ?? mediaIndiceANS;
          valorMensalAtualANS *= (1 + indice);
        }
        valoresANS.push(valorMensalAtualANS.toFixed(2));
      }

      const totalPago = valoresReais.reduce((acc, val) => acc + parseFloat(val), 0);
      const totalANS = valoresANS.reduce((acc, val) => acc + parseFloat(val), 0);
      const diferenca = totalPago - totalANS;

      // Tabela
      let html = `<h3>Resultado da SimulaÃ§Ã£o</h3>
      <table>
        <tr class="destaque"><td>Valor total pago</td><td>Valor devido pela ANS</td><td>DiferenÃ§a</td></tr>
        <tr><td>R$ ${totalPago.toFixed(2)}</td><td>R$ ${totalANS.toFixed(2)}</td><td>R$ ${diferenca.toFixed(2)}</td></tr>
      </table>`;

      // Gerar grÃ¡fico
      const ctx = document.getElementById("grafico").getContext("2d");
      if (window.grafico) window.grafico.destroy();
      window.grafico = new Chart(ctx, {
        type: 'line',
        data: {
          labels: meses,
          datasets: [
            {
              label: 'Valor Pago (Plano)',
              data: valoresReais,
              borderColor: 'red',
              fill: false
            },
            {
              label: 'Valor Devido (ANS)',
              data: valoresANS,
              borderColor: 'green',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: 'R$ por mÃªs' }
            }
          }
        }
      });

      document.getElementById("resultado").innerHTML = html;
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.addImage(document.getElementById("logo"), 'PNG', 10, 10, 50, 20);
      doc.text("SimulaÃ§Ã£o de Reajuste", 70, 30);
      doc.html(document.getElementById("resultado"), {
        callback: function (doc) {
          const canvas = document.querySelector("#grafico");
          const imgData = canvas.toDataURL("image/png");
          doc.addPage();
          doc.addImage(imgData, 'PNG', 10, 20, 180, 100);
          doc.save("simulacao.pdf");
        }
      });
    }
  </script>
</body>
</html>
